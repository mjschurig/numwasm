name: Build WASM Artifacts

on:
  push:
    branches: [main]
    paths:
      # numwasm C sources
      - 'packages/numwasm/src/wasm/**'
      - 'packages/numwasm/scripts/*.sh'
      # sciwasm C/C++ sources
      - 'packages/sciwasm/src/wasm/**'
      - 'packages/sciwasm/scripts/*.sh'
      # symwasm C++ sources
      - 'packages/symwasm/src/wasm/**'
      - 'packages/symwasm/scripts/*.sh'
      # This workflow itself
      - '.github/workflows/build-wasm.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  build-numwasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check cache
        id: cache-check
        uses: actions/cache/restore@v4
        with:
          path: wasm-artifacts/numwasm-dist
          key: numwasm-dist-${{ hashFiles('packages/numwasm/src/wasm/**', 'packages/numwasm/scripts/*.sh') }}
          lookup-only: true

      - name: Install pnpm
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Emscripten
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'

      - name: Install dependencies
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm install

      - name: Build numwasm
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm --filter numwasm run build

      - name: Prepare artifact
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: |
          mkdir -p wasm-artifacts
          cp -r packages/numwasm/dist wasm-artifacts/numwasm-dist

      - name: Save to cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: wasm-artifacts/numwasm-dist
          key: numwasm-dist-${{ hashFiles('packages/numwasm/src/wasm/**', 'packages/numwasm/scripts/*.sh') }}

  build-sciwasm:
    runs-on: ubuntu-latest
    needs: build-numwasm  # sciwasm depends on numwasm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check cache
        id: cache-check
        uses: actions/cache/restore@v4
        with:
          path: wasm-artifacts/sciwasm-dist
          key: sciwasm-dist-${{ hashFiles('packages/sciwasm/src/wasm/**', 'packages/sciwasm/scripts/*.sh') }}
          lookup-only: true

      - name: Install pnpm
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Emscripten
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'

      - name: Install dependencies
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm install

      # Restore numwasm from cache (needed as peer dependency)
      - name: Restore numwasm from cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: wasm-artifacts/numwasm-dist
          key: numwasm-dist-${{ hashFiles('packages/numwasm/src/wasm/**', 'packages/numwasm/scripts/*.sh') }}

      - name: Restore numwasm dist
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: |
          if [ -d "wasm-artifacts/numwasm-dist" ]; then
            cp -r wasm-artifacts/numwasm-dist packages/numwasm/dist
          fi

      - name: Build sciwasm
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm --filter sciwasm run build

      - name: Prepare artifact
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: |
          mkdir -p wasm-artifacts
          cp -r packages/sciwasm/dist wasm-artifacts/sciwasm-dist

      - name: Save to cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: wasm-artifacts/sciwasm-dist
          key: sciwasm-dist-${{ hashFiles('packages/sciwasm/src/wasm/**', 'packages/sciwasm/scripts/*.sh') }}

  build-symwasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check cache
        id: cache-check
        uses: actions/cache/restore@v4
        with:
          path: wasm-artifacts/symwasm-dist
          key: symwasm-dist-${{ hashFiles('packages/symwasm/src/wasm/**', 'packages/symwasm/scripts/*.sh') }}
          lookup-only: true

      - name: Install pnpm
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Emscripten
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'

      - name: Install dependencies
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm install

      - name: Build symwasm
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: pnpm --filter symwasm run build

      - name: Prepare artifact
        if: steps.cache-check.outputs.cache-hit != 'true'
        run: |
          mkdir -p wasm-artifacts
          cp -r packages/symwasm/dist wasm-artifacts/symwasm-dist

      - name: Save to cache
        if: steps.cache-check.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: wasm-artifacts/symwasm-dist
          key: symwasm-dist-${{ hashFiles('packages/symwasm/src/wasm/**', 'packages/symwasm/scripts/*.sh') }}
